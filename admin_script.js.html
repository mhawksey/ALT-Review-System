<script>
  $(function() {
    var IS_FILTERED = true;
    var SHEET = {};

    // get all submissions from the google sheet
    google.script.run.withSuccessHandler(getSubs)
      .getAllSubmissionData(mode);

    // get all submissions handler
    function getSubs(sheet) {
      SHEET = JSON.parse(sheet);
      showSubs(currentRow);
    }
    // update dialog title text
    $('#rowNum').text(currentRow);

    // pagination events
    $('#pagePrev').on('click', function() {
      currentRow--;
      showSubs(currentRow, '--');
    });
    $('#pageNext').on('click', function() {
      currentRow++;
      showSubs(currentRow, '++');
    });

    // filter event
    $('#include_filter').on('click', function() {
      IS_FILTERED = !IS_FILTERED;
      $(this).toggleClass("active")
    });

    // include/exclude buttons event
    $("[id$='_review']").on('click', function(el) {
      $('.progress').show();
      $("[id$='_review']").removeClass('active');
      $("[id$='_review']").addClass('disabled');
      var value = el.target.id.split('_')[0];
      google.script.run.withSuccessHandler(function(result) {
        console.log(result);
        $("[id$='_review']").removeClass('active')
        $("[id$='_review']").removeClass('disabled');
        $('#' + result).addClass('active');
        $('.progress').hide();
      }).setReviewStatus(currentRow, value);
    });

    // pagination event handler
    function showSubs(showRow, direction) {
      var data = SHEET;
      var r = data[showRow - 2];
      if (IS_FILTERED && r['hidden'] !== undefined) {
        eval('currentRow' + direction);
        return showSubs(currentRow, direction);
      }
      $('#rowNum').text(currentRow - 1);
      updateFields(r);
      // add review responses
      if (mode === 'reviewAdmin' || mode === 'reviewAdmin2') {
        $('[id$=_but]').removeClass('disabled')
          .removeAttr('clicked');
        // remove collapsible
        $('#reviews_text').empty();
        $("#feedback_decision").val(r['Decision R1']);
        $("#different_type").val(r['different_type']);
        console.log(r['different_type']);
        $("#hashed_id").val(r['Hashed ID']);
        $('#feedback_area').val(r['Feedback Text']);
        if (r['Decision Status R1'] !== "") {
          $('#saved_but').text('Update Decision');
        } else {
          $('#saved_but').text('Save Decision');
        }
        if (r['Decision Status R1'] === "sent" || r['Decision Status R1'] === "reminder_sent") {
          $('#saved_but').addClass('disabled');
        }
        default_feedback = "";
        for (var i = 1; i <= 4; i++) {
          var rev = 'Review' + i;
          var resp = r[rev + ' Status'];
          var type = resp.split('_');
          $('#' + rev + ' .review_dec > i').addClass(type[0]);
          $('#' + rev + ' .status').text(resp);
          $('#' + rev + ' .type').text(r[rev + ' Type']);
          if (resp === 'accept_different_type') {
            $('#' + rev + ' .review_type').show();
          } else {
            $('#' + rev + ' .review_type').hide();
          }
          var icon = $('#' + rev + ' .review_dec > i');
          if (type[0] === 'accept' && type.length === 1) {
            icon.text('sentiment_very_satisfied');
          } else if (type[0] === 'accept') {
            icon.text('sentiment_satisfied');
          } else if (type[0] === 'reject') {
            icon.text('sentiment_very_dissatisfied');
          } else if (type[0] === 'resubmit') {
            icon.text('sentiment_dissatisfied');
          } else {
            icon.text('block');
          }

          if (r[rev + ' Text']) {
            var review_feedback = 'Reviewer ' + i + '\n' + (r[rev + ' Text']) + '\n\n';
            default_feedback += review_feedback
            if (r['Feedback Text'] === "") {
              var feed = $('#feedback_area');
              var cur = feed.val();
              var append = cur + review_feedback;
              feed.val(append);
            }
          }
        }

      }
      // Final review features
      if (mode === 'reviewAdmin2') {
        $('#saved_but').closest('.row').hide();
        //$('#decision_but').show();
        $('#feedback_decision,#feedback_area').attr('disabled', true);
        
        // set RSVP status
        $('#RSVP .status').text(r['RSVP']);
        $('#RSVP .sub_status > i').addClass(r['RSVP']);
        if (r['RSVP'] === 'proposal_include'){
          $('#RSVP .sub_status > i').text('sentiment_very_satisfied');
        } else if(r['RSVP'] === 'proposal_withdraw'){
          $('#RSVP .sub_status > i').text('sentiment_very_dissatisfied');
        }
        
        // set update status
        $('#Status .status').text(r['Submission Status']);
        $('#Status .sub_status > i').addClass(r['Submission Status']);
        if (r['Submission Status'] === 'updated'){
          $('#Status .sub_status > i').text('sentiment_very_satisfied');
        }
        
        $('#submission_decision').val(r['Final Decision']);
        $('#decision_notes_area').val(r['Final Decision Notes']);
        
        // handle compare
        // add compare button for description, content and references
        var labels = $("label[for='desc_area'],label[for='eval_area'],label[for='ref_area']");
        $.each(labels, function(){
          $(this).append('<span> (<a href="#" id="compare_'+$(this).attr('for')+'">compare</a>)</span>');
        });
        
      }
      
      var toReview = r['Include']
      $("[id$='_review']").removeClass('active');
      $('#' + toReview + '_review').addClass('active');
      
      // Refresh materialize components
      M.updateTextFields();
      // M.textareaAutoResize($('.materialize-textarea'));
      $('.materialize-textarea').each(function() {
        M.textareaAutoResize($('#' + $(this).attr('id')));
      });
      $('#feedback_decision,#different_type,#submission_decision').formSelect().change();
    }

    // review form event
    $("#decision_form,#decision_form2").on('submit', function(e) {
      e.preventDefault();
      var action = $("[id$=_but][clicked=true]").removeAttr('clicked')
        .prop("id")
        .split('_')[0];
      $('#action').val(action);
      $('[id$=_but]').addClass('disabled');
      $('.progress').show();
      google.script.run.withSuccessHandler(handleReviewAdminResponse)
        .processReviewAdminForm(this);

      $('.setting').attr("disabled", true);
      //$('select').formSelect();
    });
    
    

    $('[id$=_but]').on('click', function() {
      $("button[type=submit]", $(this).parents("form")).removeAttr("clicked");
      $(this).attr("clicked", "true");
    });

    $('#reset_feedback').on('click', function(e) {
      e.preventDefault();
      $('#feedback_area').val(default_feedback);
      M.textareaAutoResize($('#feedback_area'));
    });

    // review form event handler
    function handleReviewAdminResponse(data) {
      $('.progress').hide();
      $('[id$=_but]').removeClass('disabled');
      $('#saved_but,#decision_but').text('Update Decision');
      if (data.action === 'decision'){
        $('#submission_decision, #decision_notes_area').removeAttr('disabled')
      } else {
        $('#feedback_area, #feedback_decision, #select_different_type').removeAttr('disabled');
      }
      console.log(data);
    }
    
  });
</script>
